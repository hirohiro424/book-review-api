{% extends 'base.html' %}
{% block content %}
<h2>ğŸ–‹ï¸ ì‘ê°€ ëª©ë¡</h2>

<a href="{% url 'author_create' %}">â• ì‘ê°€ ë“±ë¡</a>
<button onclick="loadDashboard()">ğŸ“Š ì‘ê°€ ëŒ€ì‹œë³´ë“œ</button>

<ul id="author-list">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</ul>
<div id="pagination"></div>

<!-- Dashboard ì˜ì—­ -->
<div id="dashboard" style="margin-top: 30px;"></div>

<script>
function getCSRFToken() {
  return document.cookie.split('; ')
    .find(row => row.startsWith('csrftoken='))
    ?.split('=')[1];
}

function deleteAuthor(authorId) {
  if (!confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”?")) return;

  fetch(`/api/authors/${authorId}/`, {
    method: "DELETE",
    headers: {
      "X-CSRFToken": getCSRFToken()
    }
  }).then(res => {
    if (res.ok) {
      alert("ì‚­ì œ ì™„ë£Œ");
      loadAuthors();  // ëª©ë¡ ê°±ì‹ 
    } else {
      alert("ì‚­ì œ ì‹¤íŒ¨");
    }
  });
}

function loadAuthors(url = "/api/authors/") {
  fetch(url)
    .then(res => res.json())
    .then(data => {
      const list = document.getElementById("author-list");
      list.innerHTML = "";

      data.results.forEach(author => {
        const li = document.createElement("li");
        li.innerHTML = `
          ${author.name}
          <a href="/web/authors/${author.id}/update/">âœï¸ ìˆ˜ì •</a>
          <button onclick="deleteAuthor(${author.id})">ğŸ—‘ï¸ ì‚­ì œ</button>
        `;
        list.appendChild(li);
      });

      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";
      if (data.previous) {
        const prev = document.createElement("button");
        prev.innerText = "â—€ ì´ì „";
        prev.onclick = () => loadAuthors(data.previous);
        pagination.appendChild(prev);
      }
      if (data.next) {
        const next = document.createElement("button");
        next.innerText = "ë‹¤ìŒ â–¶";
        next.onclick = () => loadAuthors(data.next);
        pagination.appendChild(next);
      }
    });
}

function loadDashboard() {
  fetch("/api/dashboard/authors/")
    .then(res => res.json())
    .then(data => {
      const dashDiv = document.getElementById("dashboard");
      let html = "<h3>ğŸ“Š ì‘ê°€ ëŒ€ì‹œë³´ë“œ</h3>";
      html += "<table border='1' cellpadding='5'><tr><th>ì‘ê°€ ID</th><th>ì´ë¦„</th><th>ì±… ìˆ˜</th></tr>";

      data.forEach(author => {
        html += `<tr>
          <td>${author.author_id}</td>
          <td>${author.author_name}</td>
          <td>${author.book_count}</td>
        </tr>`;
      });

      html += "</table>";
      dashDiv.innerHTML = html;
    });
}

loadAuthors();
</script>
{% endblock %}
