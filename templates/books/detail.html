{% extends 'base.html' %}
{% block content %}
<h2>ğŸ“– ì±… ìƒì„¸</h2>
<div id="book-detail">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

<h3>ğŸ’¬ ê´€ë ¨ ë¦¬ë·°</h3>
<ul id="book-reviews">ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</ul>

{% if user.is_authenticated %}
<h4>âœï¸ ë¦¬ë·° ì‘ì„±</h4>
<form id="review-form">
  <textarea name="content" rows="3" placeholder="ë‚´ìš©"></textarea><br>
  <input type="number" name="rating" min="1" max="10" placeholder="í‰ì  (1~10)"><br>
  <button type="submit">ë“±ë¡</button>
</form>
{% endif %}

<script>
function getCSRFToken() {
  return document.cookie.split('; ')
    .find(row => row.startsWith('csrftoken='))
    ?.split('=')[1];
}

const bookId = {{ book_id }};
const userId = {{ request.user.id|default:"null" }};

fetch(`/api/books/${bookId}/`)
  .then(res => res.json())
  .then(data => {
    fetch(`/api/authors/${data.author}/`)
      .then(res => res.json())
      .then(authorData => {
        document.getElementById('book-detail').innerHTML = `
          <b>ì œëª©:</b> ${data.title}<br>
          <b>ì‘ê°€:</b> ${authorData.name}<br>
        `;
      });
  });

function loadReviews() {
  fetch(`/api/books/${bookId}/reviews/`)
    .then(res => res.json())
    .then(data => {
      const ul = document.getElementById('book-reviews');
      ul.innerHTML = '';
      data.forEach(r => {
        const li = document.createElement('li');
        li.innerHTML = `
          <b>${r.user}</b>: ${r.content} <small>(${r.rating}/10)</small>
          ${r.user === userId ? `
            <a href="#">âœï¸ ìˆ˜ì •</a>
            <button onclick="deleteReview(${r.id})">ğŸ—‘ï¸ ì‚­ì œ</button>
          ` : ''}
        `;
        ul.appendChild(li);
      });
    });
}

function deleteReview(reviewId) {
  if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  fetch(`/api/reviews/${reviewId}/`, {
    method: 'DELETE',
    headers: {
      'X-CSRFToken': getCSRFToken()
    }
  }).then(res => {
    if (res.ok) loadReviews();
    else res.json().then(console.log);
  });
}

const form = document.getElementById('review-form');
if (form) {
  form.onsubmit = function (e) {
    e.preventDefault();
    fetch(`/api/reviews/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      },
      body: JSON.stringify({
        content: form.content.value,
        rating: parseInt(form.rating.value),
        book: bookId,
        user: userId
      })
    }).then(res => {
      if (res.ok) loadReviews();
      else res.json().then(console.log);
    });
  };
}

loadReviews();
</script>
{% endblock %}
