{% extends 'base.html' %}
{% block content %}
<h2>ğŸ“š Book List</h2>
<a href="{% url 'book_create' %}">â• Add Book</a>
<ul id="book-list"><li>Loading...</li></ul>
<div id="pagination"></div>

<script>
function getCSRFToken() {
  return document.cookie.split('; ')
    .find(row => row.startsWith('csrftoken='))
    ?.split('=')[1];
}

let nextUrl = '/api/books/';

function loadBooks(url) {
  fetch(url)
    .then(res => res.json())
    .then(data => {
      const list = document.getElementById('book-list');
      list.innerHTML = '';
      data.results.forEach(book => {
        fetch(`/api/authors/${book.author}/`)
          .then(res => res.json())
          .then(authorData => {
            const li = document.createElement('li');
            li.innerHTML = `
              <b>${book.title}</b> (by ${authorData.name})<br>
              í‰ì : ${book.avg_rating} / ë¦¬ë·° ìˆ˜: ${book.review_count}<br>
              <a href="/web/books/${book.id}/">ğŸ“– Detail</a>
              <a href="/web/books/${book.id}/update/">âœï¸ Edit</a>
              <button onclick="deleteBook(${book.id})">ğŸ—‘ï¸ Delete</button>
              <hr>
            `;
            list.appendChild(li);
          });
      });
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = '';
      if (data.previous) {
        const prev = document.createElement('button');
        prev.innerText = 'â—€ ì´ì „';
        prev.onclick = () => loadBooks(data.previous);
        pagination.appendChild(prev);
      }
      if (data.next) {
        const next = document.createElement('button');
        next.innerText = 'ë‹¤ìŒ â–¶';
        next.onclick = () => loadBooks(data.next);
        pagination.appendChild(next);
      }
    });
}

function deleteBook(id) {
  fetch(`/api/books/${id}/`, {
    method: 'DELETE',
    headers: {
      'X-CSRFToken': getCSRFToken()
    }
  }).then(() => loadBooks(nextUrl));
}

loadBooks(nextUrl);
</script>
{% endblock %}