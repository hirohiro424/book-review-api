{% extends 'base.html' %}
{% block content %}
<h2>ğŸ“ ë¦¬ë·° ìƒì„¸</h2>
<div id="review-detail">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

<script>
const reviewId = {{ review_id }};
const currentUserId = {{ user.id|default:"null" }};
const currentUsername = "{{ user.username|default:'Anonymous' }}";

function getCSRFToken() {
  return document.cookie.split('; ')
    .find(row => row.startsWith('csrftoken='))
    ?.split('=')[1];
}

fetch(`/api/reviews/${reviewId}/`)
  .then(res => res.json())
  .then(data => {
    const bookId = data.book;
    const userId = data.user;
    const content = data.content;
    const rating = data.rating;

    fetch(`/api/books/${bookId}/`).then(res => res.json()).then(bookData => {
      const container = document.getElementById('review-detail');

      let html = `
        <b>ì±… ì œëª©:</b> ${bookData.title}<br>
        <b>ì‘ì„±ì ID:</b> ${userId}<br>
        <div id="review-content">
          <b>ë‚´ìš©:</b> ${content}<br>
          <b>í‰ì :</b> ${rating}/5<br>
        </div>
      `;

      if (userId == currentUserId) {
        html += `
          <button onclick="showEditForm('${content.replace(/'/g, "\\'")}', ${rating}, ${bookId})">âœï¸ ìˆ˜ì •</button>
          <button onclick="deleteReview(${reviewId})">ğŸ—‘ï¸ ì‚­ì œ</button>
          <div id="edit-form" style="display:none; margin-top:15px;">
            <h3>ë¦¬ë·° ìˆ˜ì •</h3>
            <form onsubmit="submitEdit(event)">
              <textarea name="content" rows="4" cols="40">${content}</textarea><br>
              <input type="number" name="rating" min="1" max="10" value="${rating}"><br>
              <input type="hidden" name="book" value="${bookId}">
              <button type="submit">ìˆ˜ì • ì™„ë£Œ</button>
              <button type="button" onclick="cancelEdit()">ì·¨ì†Œ</button>
            </form>
          </div>
        `;
      }

      container.innerHTML = html;
    });
  });

function deleteReview(id) {
  fetch(`/api/reviews/${id}/`, {
    method: 'DELETE',
    headers: {
      'X-CSRFToken': getCSRFToken()
    }
  }).then(() => {
    alert('ë¦¬ë·°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    window.location.href = "/web/reviews/";
  });
}

function showEditForm(content, rating, bookId) {
  document.getElementById('edit-form').style.display = 'block';
}

function cancelEdit() {
  document.getElementById('edit-form').style.display = 'none';
}

function submitEdit(event) {
  event.preventDefault();
  const form = event.target;
  const content = form.content.value;
  const rating = parseInt(form.rating.value);
  const book = parseInt(form.book.value);

  fetch(`/api/reviews/${reviewId}/`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCSRFToken()
    },
    body: JSON.stringify({ content, rating, book })
  }).then(res => {
    if (res.ok) {
      alert('ë¦¬ë·°ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
      location.reload();
    } else {
      res.json().then(console.log);
    }
  });
}
</script>
{% endblock %}
